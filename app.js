// Word packs data - 20 packs organized by difficulty with sub-packs
let wordPacks = [{"id":1,"title":"P1: 0A. YEAR 1 HIGH FREQUENCY - Pack 1","description":"100 words to know by end of Year 1 (Pack 1 of 4)","category":"0A. YEAR 1 HIGH FREQUENCY - Pack 1","words":["ab","about","all","an","and","are","as","asked","at","back","be","big","but","by","called","came","can","children","come","could","dad","day","do","don't","down","for","from","get","go","got"],"subPack":"Year 1 High Frequency Words","subPackDescription":"Most common words - great starting point!"},{"id":2,"title":"P2: 0A. YEAR 1 HIGH FREQUENCY - Pack 2","description":"100 words to know by end of Year 1 (Pack 2 of 4)","category":"0A. YEAR 1 HIGH FREQUENCY - Pack 2","words":["had","have","he","help","her","here","him","his","house","i","i'm","if","in","into","is","it","it's","just","like","little","look","looked","made","make","me","mr","mrs","mum","my","no"],"subPack":"Year 1 High Frequency Words","subPackDescription":"Most common words - great starting point!"},{"id":3,"title":"P3: 0A. YEAR 1 HIGH FREQUENCY - Pack 3","description":"100 words to know by end of Year 1 (Pack 3 of 4)","category":"0A. YEAR 1 HIGH FREQUENCY - Pack 3","words":["not","now","of","off","oh","old","on","one","out","people","put","said","saw","see","she","so","some","that","the","their","them","then","there","they","this","time","to","too","up","very"],"subPack":"Year 1 High Frequency Words","subPackDescription":"Most common words - great starting point!"},{"id":4,"title":"P4: 0A. YEAR 1 HIGH FREQUENCY - Pack 4","description":"100 words to know by end of Year 1 (Pack 4 of 4)","category":"0A. YEAR 1 HIGH FREQUENCY - Pack 4","words":["was","we","went","were","what","when","will","with","you","your"],"subPack":"Year 1 High Frequency Words","subPackDescription":"Most common words - great starting point!"},{"id":5,"title":"P5: 1. SHORT VOWEL A - Pack 1","description":"CVC words with 'a' as in cat (Pack 1 of 2)","category":"1. SHORT VOWEL A - Pack 1","words":["assistant","attack","attic","bad","bag","bat","cab","cap","cat","dab","fan","fat","gal","gap","gas","ham","has","hat","jab","jam","kit","lap","mad","man","map","mat","max","nag","nap","napkin"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":6,"title":"P6: 1. SHORT VOWEL A - Pack 2","description":"CVC words with 'a' as in cat (Pack 2 of 2)","category":"1. SHORT VOWEL A - Pack 2","words":["pal","pan","pasta","pat","rag","ram","ran","rap","rat","sad","sap","sat","span","spank","spick","stack","tab","tact","tag","tan","tap","tax","van","wag","wax","yam","zap"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":7,"title":"P7: 1. SHORT VOWEL E - Pack 1","description":"CVC words with 'e' as in bed (Pack 1 of 2)","category":"1. SHORT VOWEL E - Pack 1","words":["antenna","antiseptic","arrest","bed","beg","bell","ben","best","bet","cassette","deck","den","fed","fell","gem","hem","hen","insect","inspect","jet","kitten","led","leg","less","let","men","mess","met","neck","nest"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":8,"title":"P8: 1. SHORT VOWEL E - Pack 2","description":"CVC words with 'e' as in bed (Pack 2 of 2)","category":"1. SHORT VOWEL E - Pack 2","words":["net","packet","peck","peg","pen","pest","pet","red","rest","sell","sense","sent","set","speck","step","tell","ten","tennis","tense","tent","test","ticket","vest","vet","wed","well","west","wet","yell","yet"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":9,"title":"P9: 1. SHORT VOWEL I - Pack 1","description":"CVC words with 'i' as in sit (Pack 1 of 2)","category":"1. SHORT VOWEL I - Pack 1","words":["ant","assist","bib","bin","bit","did","dig","dim","din","dip","fig","fin","fit","fix","gig","hid","hip","hit","insist","its","jig","kick","kid","lick","lid","lip","lit","mix","nip","nit"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":10,"title":"P10: 1. SHORT VOWEL I - Pack 2","description":"CVC words with 'i' as in sit (Pack 2 of 2)","category":"1. SHORT VOWEL I - Pack 2","words":["pant","pants","pick","pig","pin","pip","pit","rib","rid","rig","rim","rip","sick","sip","sit","six","snap","snip","spat","spin","spit","tick","tin","tip","wick","wig","win","wit","zip"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":11,"title":"P11: 1. SHORT VOWEL O - Pack 1","description":"CVC words with 'o' as in dog (Pack 1 of 3)","category":"1. SHORT VOWEL O - Pack 1","words":["across","adopt","block","bob","bog","box","cannon","cannot","carrot","clock","cob","cod","cog","comic","connect","correct","cost","cot","cotton","crop","cross","desktop","dock","dog","dot","dragon","drop","fog","fox","god"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":12,"title":"P12: 1. SHORT VOWEL O - Pack 2","description":"CVC words with 'o' as in dog (Pack 2 of 3)","category":"1. SHORT VOWEL O - Pack 2","words":["haddock","hog","hop","hot","incorrect","job","jog","jot","kiosk","lock","log","lot","maggot","mob","mock","mom","mop","moss","nod","nonsense","odd","opinion","parrot","pocket","pod","pond","pop","pot","pox","protect"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":13,"title":"P13: 1. SHORT VOWEL O - Pack 3","description":"CVC words with 'o' as in dog (Pack 3 of 3)","category":"1. SHORT VOWEL O - Pack 3","words":["reckon","rob","rock","rocket","rod","rot","second","shock","sob","sock","spot","spotted","stop","ticktock","top","topic","trod","trot"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":14,"title":"P14: 1. SHORT VOWEL U - Pack 1","description":"CVC words with 'u' as in cup (Pack 1 of 3)","category":"1. SHORT VOWEL U - Pack 1","words":["bud","bug","bump","bun","bus","crust","cub","cud","cup","cut","discuss","drug","drum","drunk","duck","dug","dumb","dump","dust","eggcup","fun","grunt","gum","gun","gust","gut","hiccup","hippopotamus","hug","hum"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":15,"title":"P15: 1. SHORT VOWEL U - Pack 2","description":"CVC words with 'u' as in cup (Pack 2 of 3)","category":"1. SHORT VOWEL U - Pack 2","words":["hump","hunt","hut","instruct","jug","jump","jut","lump","minimum","mud","mug","mumps","must","nun","nut","product","pub","pump","pumpkin","pun","pup","puppet","putt","rub","rucksack","rug","rump","run","rust","rut"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":16,"title":"P16: 1. SHORT VOWEL U - Pack 3","description":"CVC words with 'u' as in cup (Pack 3 of 3)","category":"1. SHORT VOWEL U - Pack 3","words":["scrub","skunk","snug","spun","stuck","stump","sub","suck","sudden","sum","sun","sunk","sunset","suntan","tantrum","truck","trumpet","trunk","trust","tub","tuck","tug","tusk","undid","undress","unpack","upon","upset","us","yum"],"subPack":"Short Vowels","subPackDescription":"Basic phonics - short a, e, i, o, u sounds"},{"id":17,"title":"P17: 2. 3-LETTER BLENDS","description":"scr, spr, str, spl, thr","category":"2. 3-LETTER BLENDS","words":["scrape","screen","screw","splash","splendid","splint","sprain","spray","spread","spring","sprout","strap","stream","street","string","strip","strong","three","throat","throne","throw"],"subPack":"Consonant Blends","subPackDescription":"Two or more consonants together"},{"id":18,"title":"P18: 2. L-BLENDS - Pack 1","description":"bl, cl, fl, gl, pl, sl (Pack 1 of 2)","category":"2. L-BLENDS - Pack 1","words":["black","blast","blend","bless","blob","blot","blue","blunt","clamp","clap","clip","club","clump","flag","flan","flat","flip","flock","flop","flow","glad","glass","glide","glow","glue","glum","plan","plank","play","plot"],"subPack":"Consonant Blends","subPackDescription":"Two or more consonants together"},{"id":19,"title":"P19: 2. L-BLENDS - Pack 2","description":"bl, cl, fl, gl, pl, sl (Pack 2 of 2)","category":"2. L-BLENDS - Pack 2","words":["plug","plum","plump","plus","skill","skull","slam","slap","sled","slept","slid","slim","slip","slit","slot","slow","slug","smell","spell","spelt","spill","split"],"subPack":"Consonant Blends","subPackDescription":"Two or more consonants together"},{"id":20,"title":"P20: 2. R-BLENDS - Pack 1","description":"br, cr, dr, fr, gr, pr, tr (Pack 1 of 2)","category":"2. R-BLENDS - Pack 1","words":["brave","brick","bring","brown","brush","crab","crack","crash","crown","cry","drab","drag","dress","drill","drip","frank","frantic","free","fresh","frill","frog","frost","grab","gram","green","grim","grin","grip","pray","press"],"subPack":"Consonant Blends","subPackDescription":"Two or more consonants together"}];

// State
let currentPack = null;
let currentWordIndex = 0;
let reviewMode = false;
let reviewWords = [];
let currentSubPack = null;
let currentSortColumn = null;
let currentSortDirection = 'asc';

// Initialize app
function init() {
    loadWordPacks();
    setupEventListeners();
}

// Setup event listeners
function setupEventListeners() {
    document.getElementById('backBtn').onclick = () => showScreen('homeScreen');
    document.getElementById('prevBtn').onclick = () => navigateWord(-1);
    document.getElementById('nextBtn').onclick = () => navigateWord(1);
    document.getElementById('trickyBtn').onclick = () => markWord('tricky');
    document.getElementById('gotItBtn').onclick = () => markWord('got-it');
    document.getElementById('homeBtn').onclick = () => showScreen('homeScreen');
    document.getElementById('parentBtn').onclick = showParentView;
}

// Load and render packs
function loadWordPacks() {
    renderSubPackList();
}

// Get progress from localStorage
function getProgress() {
    const saved = localStorage.getItem('wordPackProgress');
    return saved ? JSON.parse(saved) : {};
}

// Save progress
function saveProgress(progress) {
    localStorage.setItem('wordPackProgress', JSON.stringify(progress));
}

// Get pack progress
function getPackProgress(packId) {
    const progress = getProgress();
    if (!progress[packId]) {
        progress[packId] = {
            words: {},
            completed: false,
            lastReviewed: null
        };
    }
    return progress[packId];
}

// Update pack progress
function updatePackProgress(packId, wordIndex, status) {
    const progress = getProgress();
    if (!progress[packId]) {
        progress[packId] = { words: {}, completed: false, lastReviewed: null };
    }
    progress[packId].words[wordIndex] = status;

    // Check if pack is fully reviewed
    const pack = wordPacks.find(p => p.id === packId);
    const allWordsReviewed = pack.words.every((_, idx) => progress[packId].words[idx]);
    if (allWordsReviewed) {
        progress[packId].lastReviewed = new Date().toISOString();
        progress[packId].completed = true;
    }

    saveProgress(progress);
}

// Get unique sub-packs
function getSubPacks() {
    const subPacks = {};
    wordPacks.forEach(pack => {
        if (!subPacks[pack.subPack]) {
            subPacks[pack.subPack] = {
                name: pack.subPack,
                description: pack.subPackDescription,
                packs: []
            };
        }
        subPacks[pack.subPack].packs.push(pack);
    });
    return Object.values(subPacks);
}

// Get tricky words at different levels
function getTrickyWords(level = 'global', filter = null) {
    const progress = getProgress();
    const trickyWords = [];

    wordPacks.forEach(pack => {
        // Filter by level
        if (level === 'subpack' && pack.subPack !== filter) return;
        if (level === 'pack' && pack.id !== filter) return;

        const packProgress = progress[pack.id];
        if (!packProgress) return;

        pack.words.forEach((word, idx) => {
            if (packProgress.words[idx] === 'tricky') {
                trickyWords.push({
                    word,
                    packId: pack.id,
                    packTitle: pack.title,
                    wordIndex: idx
                });
            }
        });
    });

    return trickyWords;
}

// Render sub-pack list
function renderSubPackList() {
    const container = document.getElementById('packList');
    container.innerHTML = '';

    const subPacks = getSubPacks();

    // Global tricky words button
    const globalTrickyWords = getTrickyWords('global');
    if (globalTrickyWords.length > 0) {
        const globalBtn = document.createElement('button');
        globalBtn.className = 'tricky-review-btn global';
        globalBtn.textContent = `Review All Tricky Words (${globalTrickyWords.length})`;
        globalBtn.onclick = () => startTrickyReview('global');
        container.appendChild(globalBtn);
    }

    // Render each sub-pack
    subPacks.forEach(subPack => {
        const subPackDiv = document.createElement('div');
        subPackDiv.className = 'sub-pack';

        const subPackTrickyWords = getTrickyWords('subpack', subPack.name);

        subPackDiv.innerHTML = `
            <div class="sub-pack-header">
                <h2>${subPack.name}</h2>
                <p>${subPack.description}</p>
                ${subPackTrickyWords.length > 0 ? `<button class="tricky-review-btn subpack" onclick="startTrickyReview('subpack', '${subPack.name}')">Review Tricky Words (${subPackTrickyWords.length})</button>` : ''}
            </div>
            <div class="pack-table-container">
                ${renderPackTable(subPack.packs)}
            </div>
        `;

        container.appendChild(subPackDiv);
    });
}

// Render pack table
function renderPackTable(packs) {
    let html = `
        <table class="pack-table">
            <thead>
                <tr>
                    <th onclick="sortPacks('id')" class="sortable">Pack <span class="sort-icon">⇅</span></th>
                    <th onclick="sortPacks('words')" class="sortable">Word Preview <span class="sort-icon">⇅</span></th>
                    <th onclick="sortPacks('count')" class="sortable">Count <span class="sort-icon">⇅</span></th>
                    <th onclick="sortPacks('lastReviewed')" class="sortable">Last Reviewed <span class="sort-icon">⇅</span></th>
                    <th onclick="sortPacks('progress')" class="sortable">Progress <span class="sort-icon">⇅</span></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    packs.forEach(pack => {
        const progress = getPackProgress(pack.id);
        const totalWords = pack.words.length;
        const reviewedWords = Object.keys(progress.words).length;
        const progressPercent = Math.round((reviewedWords / totalWords) * 100);
        const lastReviewed = progress.lastReviewed ? formatDate(progress.lastReviewed) : 'Never';
        const trickyCount = pack.words.filter((_, idx) => progress.words[idx] === 'tricky').length;

        // Get first 4 words as preview
        const wordPreview = pack.words.slice(0, 4).join(', ') + (pack.words.length > 4 ? '...' : '');

        html += `
            <tr data-pack-id="${pack.id}">
                <td class="pack-number">P${pack.id}</td>
                <td class="word-preview">${wordPreview}</td>
                <td class="word-count">${totalWords}</td>
                <td>${lastReviewed}</td>
                <td>
                    <div class="progress-cell">
                        <span>${reviewedWords}/${totalWords} (${progressPercent}%)</span>
                        <div class="progress-bar-small">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                </td>
                <td class="actions-cell">
                    <button onclick="startPack(${pack.id})" class="action-btn practice">Practice</button>
                    ${trickyCount > 0 ? `<button onclick="startTrickyReview('pack', ${pack.id})" class="action-btn review-tricky">Review Tricky (${trickyCount})</button>` : ''}
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    return html;
}

// Format date
function formatDate(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));

    if (diff === 0) return 'Today';
    if (diff === 1) return 'Yesterday';
    if (diff < 7) return `${diff} days ago`;
    if (diff < 30) return `${Math.floor(diff / 7)} weeks ago`;
    if (diff < 365) return `${Math.floor(diff / 30)} months ago`;
    return date.toLocaleDateString();
}

// Sort packs
function sortPacks(column) {
    // Implement sorting logic
    alert('Sorting by ' + column + ' - coming soon!');
}

// Start tricky review
function startTrickyReview(level, filter = null) {
    reviewMode = true;
    reviewWords = getTrickyWords(level, filter);

    if (reviewWords.length === 0) {
        alert('No tricky words to review!');
        return;
    }

    currentWordIndex = 0;
    currentPack = {
        title: level === 'global' ? 'All Tricky Words' :
               level === 'subpack' ? `${filter} - Tricky Words` :
               wordPacks.find(p => p.id === filter).title + ' - Tricky Words',
        words: reviewWords.map(w => w.word),
        id: level === 'pack' ? filter : null
    };

    showScreen('practiceScreen');
    document.getElementById('packTitle').textContent = currentPack.title;
    updateWordDisplay();
}

// Start pack
function startPack(packId) {
    currentPack = wordPacks.find(p => p.id === packId);
    currentWordIndex = 0;
    reviewMode = false;

    showScreen('practiceScreen');
    document.getElementById('packTitle').textContent = currentPack.title;
    updateWordDisplay();
}

// Update word display
function updateWordDisplay() {
    const words = reviewMode ? reviewWords.map(w => w.word) : currentPack.words;
    const word = words[currentWordIndex];

    document.getElementById('currentWord').textContent = word;
    document.getElementById('wordCounter').textContent = `${currentWordIndex + 1} / ${words.length}`;

    // Update navigation buttons
    document.getElementById('prevBtn').disabled = currentWordIndex === 0;
    document.getElementById('nextBtn').disabled = currentWordIndex === words.length - 1;

    // Check if finished
    if (currentWordIndex === words.length - 1) {
        // Last word - show completion after marking
    }
}

// Navigate words
function navigateWord(direction) {
    const words = reviewMode ? reviewWords : currentPack.words;
    currentWordIndex = Math.max(0, Math.min(words.length - 1, currentWordIndex + direction));
    updateWordDisplay();
}

// Mark word
function markWord(status) {
    if (reviewMode) {
        // Update the original pack's word
        const trickyWord = reviewWords[currentWordIndex];
        updatePackProgress(trickyWord.packId, trickyWord.wordIndex, status);
    } else {
        updatePackProgress(currentPack.id, currentWordIndex, status);
    }

    // Move to next word or finish
    const words = reviewMode ? reviewWords : currentPack.words;
    if (currentWordIndex < words.length - 1) {
        navigateWord(1);
    } else {
        showCompletion();
    }
}

// Show completion screen
function showCompletion() {
    const progress = reviewMode ? null : getPackProgress(currentPack.id);
    const words = reviewMode ? reviewWords.map(w => w.word) : currentPack.words;

    const trickyWords = reviewMode ?
        reviewWords.filter((_, idx) => {
            const tw = reviewWords[idx];
            const prog = getPackProgress(tw.packId);
            return prog.words[tw.wordIndex] === 'tricky';
        }).map(w => w.word) :
        words.filter((_, idx) => progress.words[idx] === 'tricky');

    document.getElementById('completeTitle').textContent = reviewMode ? 'Review Complete!' : 'Pack Complete!';
    document.getElementById('completeStats').innerHTML = `
        <p>Total words: ${words.length}</p>
        <p>Tricky words: ${trickyWords.length}</p>
        ${trickyWords.length > 0 ? `<p>Keep practicing: ${trickyWords.join(', ')}</p>` : '<p>Great job! All words mastered!</p>'}
    `;

    showScreen('completeScreen');
}

// Show parent view
function showParentView() {
    const progress = getProgress();
    let html = '<h2>Progress Overview</h2>';

    const subPacks = getSubPacks();

    subPacks.forEach(subPack => {
        html += `<h3>${subPack.name}</h3><ul>`;

        subPack.packs.forEach(pack => {
            const packProgress = progress[pack.id];
            if (!packProgress) return;

            const trickyWords = pack.words.filter((_, idx) => packProgress.words[idx] === 'tricky');
            if (trickyWords.length > 0) {
                html += `<li><strong>${pack.title}:</strong> ${trickyWords.join(', ')}</li>`;
            }
        });

        html += '</ul>';
    });

    document.getElementById('parentContent').innerHTML = html;
    showScreen('parentScreen');
}

// Show screen
function showScreen(screenName) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenName).classList.remove('hidden');

    if (screenName === 'homeScreen') {
        renderSubPackList();
    }
}

// Initialize on load
window.onload = init;
